name: Update README pages list

on:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate pages list with titles and search
        run: |
          echo '<input type="text" id="search" placeholder="üîç Rechercher une page..." onkeyup="filterPages()" style="width:100%;padding:8px;margin-bottom:10px;">' > pages.tmp
          echo "<ul id=\"pages\">" >> pages.tmp

          for file in *.html; do
            # 1Ô∏è‚É£ Priorit√© : const PAGE_TITLE = "..."
            title=$(grep -oP 'const\s+PAGE_TITLE\s*=\s*"\K[^"]+' "$file")

            # 2Ô∏è‚É£ Sinon : balise <title>
            if [ -z "$title" ]; then
              title=$(grep -i "<title>" "$file" | sed -E 's/.*<title>(.*)<\/title>.*/\1/I')
            fi

            # 3Ô∏è‚É£ Fallback : nom du fichier
            if [ -z "$title" ]; then
              title="$file"
            fi

            echo "<li data-title=\"$title\"><a href=\"$file\">$title</a></li>" >> pages.tmp
          done

          echo "</ul>" >> pages.tmp

          echo "<script>" >> pages.tmp
          echo "function filterPages() {" >> pages.tmp
          echo "  const q = document.getElementById('search').value.toLowerCase();" >> pages.tmp
          echo "  document.querySelectorAll('#pages li').forEach(li => {" >> pages.tmp
          echo "    li.style.display = li.dataset.title.toLowerCase().includes(q) ? '' : 'none';" >> pages.tmp
          echo "  });" >> pages.tmp
          echo "}" >> pages.tmp
          echo "</script>" >> pages.tmp

          awk '
            BEGIN {print_mode=1}
            /<!-- PAGES-LIST:START -->/ {print; system("cat pages.tmp"); print_mode=0}
            /<!-- PAGES-LIST:END -->/ {print_mode=1}
            print_mode {print}
          ' README.md > README.new

          mv README.new README.md

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "üîÑ Update pages list (dynamic titles + search)" || exit 0
          git push
